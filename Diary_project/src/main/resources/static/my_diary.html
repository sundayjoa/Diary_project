<!DOCTYPE html>
	<html lang="en" xmlns:th="http://www.thymeleaf.org">
	    <head>
	        <meta charset="utf-8" />
	        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	        <meta name="description" content="" />
	        <meta name="author" content="" />
	        <title>별별일기</title>
	        <!-- Favicon-->
	        <link rel="icon" type="image/x-icon" href="assets/star_diary_logo.png" />
	        <!-- Bootstrap icons-->
	        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" type="text/css" />
	        <!-- Google fonts-->
	        <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css" />
	        <!-- Core theme CSS (includes Bootstrap)-->
	        <link href="css/base.css?after" rel="stylesheet" />
	    </head>
	    
	    <body>
	    	<!-- Navigation-->
	        <nav class="navbar navbar-light bg-light static-top custom-navbar">
	        <div class="container">
	            <div class="navbar-menu-group">
	                <a class="navbar-brand" href="index.html">
	                    <img src="assets/star_diary_logo.png" alt="Brand Logo">
	                </a>
	                <a class="navbar-menu" href="public_diary.html">
	                    <img src="assets/PublicDiary_font.png">
	                </a>
	                <a class="navbar-menu" href="my_diary.html">
	                    <img src="assets/diary_font.png">
	                </a>
	                <a class="navbar-menu" href="#!">
	                    <img src="assets/ExchangDiary_font.png">
	                </a>
	            </div>
	            <div class="ml-auto">
	                <a id="user-info" class="nav-link"></a>
	            </div>
	        </div>
	    </nav>
	    
	    <!-- My diary -->
        <section class="my-diary-section">
        	<div class="my-diary-background container px-4 px-lg-5 my-5">
                <div class="text-center text-white">
                    <h1 class="topic-title fw-bolder">나의 일기장</h1>
				        
			        <div class="my-diary-container">
				        
				    </div>
		        </div>
                	
            </div>
        </section>
        
        <!-- My diary pupup -->
		<div id="my-popup" class="popup">
		    <div class="my-popup-content">
		        <span class="close" id="closePopupBtn">&times;</span>
		        	<p id="public-check" class="my-font-7"></p>
		        	<div class="like-container" data-liked="false">
		        	<span id="like-icon-2" class="like-icon">&#9825;</span>
		        	<p id="likeCount" class="like-count"></p>
		        	</div>
		            <h2 id="my-title" class="my-font-6"></h2>  
		            <p id="my-diary-content" class="my-font-2 my-diary-content"></p>
		            <p id="diary-date" class="my-font-8"></p>
		            
		            <button type="submit" id="deleteBtn" class="deleteBtn">삭제</button>
		            <button type="submit" id="modifyBtn" class="modifyBtn">수정</button>
		    </div>
		</div>
		
		<!-- modify popup -->
		<div id="modify-popup" class="popup">
			<div class="popup-content">
				<span class="close" id="closeModify">&times;</span>
				<h1 class="my-h1 text-center top">수정 하기</h1>
				<form id="modifyForm">
				<p class="my-font-1 text-center">제목</p> 
				<div class="modify-container">
					<input type="text" id="modifyTitle" name="modifyTitle" class="modifyTitle" required>
				</div>
				<p class="my-font-1 text-center">내용</p>
				<div class="modify-container">
					<textarea id="modifyContent" name="modifyContent" class="diaryContent" required></textarea><br><br>
				</div>
				
				<div class="radio-group">
                    <div class="radio-container">
			            <input type="radio" id="public" name="visibility" value="public">
			            <p>공개</p>
		        	</div>
		        	<div class="radio-container">
			            <input type="radio" id="private" name="visibility" value="private">
			            <p>비공개</p>
		        	</div>
	        	</div>
	        	
	        	<div class="modify-container">
	        		<button type="submit" id="modify-btn" class="modify-btn">수정 완료</button>
	        
	        	</div>
				</form>
			</div>
		</div>
		
        
        
        <!-- writing button -->
        <section class="my-button-section">
        	<div class="my-diary-background container px-4 px-lg-5 my-5">
                <div class="text-center text-white">
                    
                    <a class="my-btn" href="#" id="openPopupBtn">일기 쓰러 가기!</a>
                    
                    <!-- 팝업창 -->
			        <div id="writing-popup" class="popup">
			            <div class="popup-content">
			                <span class="close" id="close-writing-PopupBtn">&times;</span>
			                <h1 class="my-h1">일기 작성</h1>
			                <a class="rc-topic" id="recommendation-topic">⒤ 일기 주제를 추천해드려요!</a>
			                
			                <!-- 주제 추천 섹션 -->
			                <div id="recommendation-section" class="hidden-section">
			                    <h3>추천 일기 주제</h3>
			                    <p class="my-h2"id="randomTopic">주제를 불러오는 중입니다...</p>
			                    <a class="recommendation-btn" href="#" id="rcBtn">주제 추천!</a>
			                </div>
			                
			                
			                <form id="diaryForm">
			                	<p class="my-font-1">제목</p>  
			                    <input type="text" id="diaryTitle" name="diaryTitle" class="diaryTitle" placeholder="제목을 입력해주세요" required>
			                    <p class="my-font-2">내용</p>  
			                    <textarea id="diaryContent" name="diaryContent" class="diaryContent" placeholder="내용을 입력해주세요" required></textarea><br><br>
			                    
			                    <div class="radio-group">
				                    <div class="radio-container">
							            <input type="radio" id="public" name="visibility" value="public">
							            <p>공개</p>
						        	</div>
						        	<div class="radio-container">
							            <input type="radio" id="private" name="visibility" value="private">
							            <p>비공개</p>
						        	</div>
					        	</div>
			                    
			                    <button type="submit" id="writing-btn" class="writing-btn">작성 완료</button>
			                </form>
			            </div>
			         </div>
			         
			         <!-- 주제 추천 팝업창 -->
			        <div id="recommendation-popup" class="rc-popup">
			            <div class="rc-popup-content">
			                <span class="close" id="closeRcPopupBtn">&times;</span>
			                <form id="recommendationForm">
			                    <p class="my-font-3">일기 주제를 추천해주세요!</p>
			                    <p class="my-font-4">*50자 이하의 주제로 추천해주세요!</p>
			                    <p class="my-font-5">*지나치게 선정적이거나 폭력적인 주제는 삭제 처리 됩니다.</p>
			                    <input type="text" id="topicContent" name="topicContent" class="topicContent" placeholder="주제를 입력해주세요" required><br>
			                    <a class="rccomplete-btn" href="#" id="rccompleteBtn">추천 완료</a>
			                </form>
			            </div>
			        </div>
                </div>
            </div>
        </section>
	    
	    <!-- footer -->
        <footer class="footer-section">
            <div class="my-background footer-container">
            	<p class="text-center text-white">Starry Diary Project<br><br> 개발자: 전효주 </p>
            </div>
        </footer>
	    
	    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
	        //게시글 
	        $(document).ready(function() {
	        //게시글 가져오기
		    $.ajax({
		        url: "/api/my_diary/posts",
		        type: "POST",
		        success: function(posts) {
		            if (posts.length === 0) {
		                $('.my-diary-container').append('<p>일기장을 작성해보세요!</p>');
		            } else {
		                // 최신 순으로 정렬
		                posts.sort(function(a, b) {
		                    return new Date(b.date) - new Date(a.date);
		                });
		                posts.forEach(function(post) {
		                    var date = new Date(post.date);
		                    var formattedDate = date.getFullYear() + '-' +
		                        ('0' + (date.getMonth() + 1)).slice(-2) + '-' +
		                        ('0' + date.getDate()).slice(-2) + ' ' +
		                        ('0' + date.getHours()).slice(-2) + ':' +
		                        ('0' + date.getMinutes()).slice(-2);
		                        
		                    
		                    var postHtml = '<div class="my-rectangle" data-diary-number="' + post.diaryNumber + '">' +
		                    	'<h2 class="public-title">' + post.title + '</h2>' +
		                        '<p class="public-content">' + post.content + '</p>' +
		                        '<p class="public-check">' + (post.isPublic ? '공개' : '비공개') + '</p>' +
		                        '<p class="public-author">' + post.name + '</p>' +
		                        '<p class="public-dateweather">' + formattedDate + '</p>' +
		                        '<div class="public-like-container" data-liked="false"><span class="like-icon">&#9825;</span><span class="like-count">0</span></div>' + 
		                        '</div>';
		                    $('.my-diary-container').append(postHtml);
		                    
		                 	// 좋아요 수 가져오기
		                    var likeCountSpan = $('.my-rectangle[data-diary-number="' + post.diaryNumber + '"]').find('.like-count');
		                    $.ajax({
		                        url: '/api/like/count',
		                        type: 'GET',
		                        data: {
		                            DiaryNumber: post.diaryNumber
		                        },
		                        success: function(likeCount) {
		                            likeCountSpan.text(likeCount);
		                        },
		                        error: function(error) {
		                            console.error("Error fetching like count:", error);
		                        }
		                    });
		                    
		                    //좋아요 여부 표시
		                    var likeIcon = $('.my-rectangle[data-diary-number="' + post.diaryNumber + '"]').find('.like-icon');
		                    
		                    $.ajax({
		                        url: '/api/like/check',
		                        type: 'GET',
		                        data: {
		                            DiaryNumber: post.diaryNumber
		                        },
		                        success: function(isLiked) {
		                            console.log("DiaryNumber:", post.diaryNumber, "Liked:", isLiked); 
		                            if (isLiked === true || isLiked === 'true') {
		                                likeIcon.html('&#9829;').css('color', 'red');
		                            } else {
		                                likeIcon.html('&#9825;');
		                            }
		                        },
		                        error: function(error) {
		                            console.error("Error checking like status:", error);
		                        }
		                    });
		                });
		            }
		        },
		        error: function(error) {
		            console.error("Error fetching posts:", error);
		            $('.my-diary-container').append('<p>Error fetching posts.</p>');
		        }
		    });
	        
	        //DiaryNumber 선언
		    var currentDiaryNumber;

		    $(document).on('click', '.my-rectangle', function() {
		        currentDiaryNumber = $(this).data('diary-number');
		        console.log("currentDiaryNumber:", currentDiaryNumber);
		    });
		    
		    
		    // 내 일기장 내용 보기
		    $(document).on('click', '.my-rectangle', function() {
		    	var likeCount = $(this).find('.like-count').text();
		        var title = $(this).find('.public-title').text();
		        var content = $(this).find('.public-content').text();
		        var isPublic = $(this).find('.public-check').text();
		        var date = $(this).find('.public-dateweather').text();
		
		        $('#likeCount').text(likeCount);
		        $('#public-check').text(isPublic);
		        $('#my-title').text(title);
		        $('#my-diary-content').html(content.replace(/\n/g, "<br>"));
		        $('#diary-date').text("작성일: " + date);
		        
		        
		      //로그인 한 사람의 좋아요 여부
				var likeIcon2 = $('#like-icon-2');
                
                $.ajax({
                    url: '/api/like/check',
                    type: 'GET',
                    data: {
                    	DiaryNumber: currentDiaryNumber
                    },
                    success: function(isLiked) {
                        console.log("DiaryNumber:", currentDiaryNumber, "Liked:", isLiked); 
                        if (isLiked === true || isLiked === 'true') {
                            likeIcon2.html('&#9829;').css('color', 'red');
                        } else {
                            likeIcon2.html('&#9825;');
                        }
                    },
                    error: function(error) {
                        console.error("Error checking like status:", error);
                    }
                });
		        // 팝업 표시
		        $('#my-popup').show();
		    });
		    
		    //좋아요 기능(추가 및 삭제)
		    $(document).on('click', '#like-icon-2', function() {
		        var likeIcon = $(this);
		        $.ajax({
		            url: '/api/like/toggle',
		            type: 'POST',
		            data: {
		                DiaryNumber: currentDiaryNumber
		            },
		            success: function(response) {
		                if (response === "좋아요 추가") {
		                    likeIcon.html('&#9829;').css('color', 'red');
		                    var likeCount = parseInt($('#likeCount').text()) + 1;
		                    $('#likeCount').text(likeCount);
		                } else {
		                    likeIcon.html('&#9825;').css('color', '');
		                    var likeCount = parseInt($('#likeCount').text()) - 1;
		                    $('#likeCount').text(likeCount);
		                }
		            },
		            error: function(error) {
		                console.error("Error toggling like:", error);
		            }
		        });
		    });
		
		    // 팝업 닫기 이벤트
		    $('#closePopupBtn').on('click', function() {
		        $('#my-popup').hide();
		    });
		    
		 	// 일기장 수정하기
		    $(document).on('click', '#modifyBtn', function() {
		        var title = $('#my-title').text();
		        var content = $('#my-diary-content').html().replace(/<br\s*\/?>/gi, '\n');
		        var isPublic = $('#public-check').text().trim();

		        $('#modifyTitle').val(title);
		        $('#modifyContent').val(content);
		        if (isPublic === '공개') {
		            $('#public').prop('checked', true);
		        } else if (isPublic === '비공개') {
		            $('#private').prop('checked', true); 
		        }
		        
		
		        // 팝업 표시
		        $('#my-popup').hide();
		        $('#modify-popup').show();
		    });
		 	
		    $('#modifyForm').on('submit', function(event) {
		        event.preventDefault();

		        var title = $('#modifyTitle').val();
		        var content = $('#modifyContent').val();
		        var visibility = $('input[name="visibility"]:checked').val();

		        if (confirm('정말로 수정하시겠습니까?')) {
		            $.ajax({
		                url: '/api/my_diary/update/' + currentDiaryNumber,
		                type: 'PUT',
		                data: {
		                    diaryTitle: title,
		                    diaryContent: content,
		                    visibility: visibility
		                },
		                success: function(result) {
		                    alert('수정이 완료되었습니다.');
		                    window.location.href = 'my_diary.html';
		                },
		                error: function(error) {
		                    console.error("Error updating post:", error);
		                    alert('저장 중 문제가 발생했습니다.');
		                }
		            });
		        }
		    });
		
		    // 팝업 닫기 이벤트
		    $('#closeModify').on('click', function() {
		        $('#modify-popup').hide();
		    });
		    
		
		    // 게시글 삭제
		    $(document).on('click', '.deleteBtn', function(event) {
		        event.stopPropagation();
		        if (confirm('정말로 삭제하시겠습니까?')) {
		            $.ajax({
		                url: '/api/my_diary/delete/' + currentDiaryNumber,
		                type: 'DELETE',
		                success: function(result) {
		                    alert('삭제되었습니다.');
		                    location.reload();
		                },
		                error: function(error) {
		                    console.error("Error deleting post:", error);
		                    alert('삭제에 실패했습니다.');
		                }
		            });
		        }
		    });
		});

        
        
	        $(document).ready(function() {
	            console.log("Document ready");
	            $.ajax({
	                type: 'GET',
	                url: '/api/session/userinfo',
	                success: function(response) {
	                    console.log("AJAX success", response);
	                    if (response && response.userID && response.userName) {
	                        $('#user-info').html(response.userName + ' 님');
	                        $('#user-info').attr("href", "#");
	                        $('#user-info').addClass('font-3');
	                    } else {
	                        $('#user-info').html('<a class="login-btn" href="login.html">로그인</a>');
	                    }
	                },
	                error: function(xhr, status, error) {
	                    console.error("AJAX error", status, error);
	                    if (xhr.status === 204) {
	                        $('#user-info').html('<a class="login-btn" href="login.html">로그인</a>');
	                    } else {
	                        $('#user-info').html('<a class="login-btn" href="login.html">로그인</a>');
	                    }
	                }
	            });
	        });
	        
	     	// 추천 주제 섹션
	        document.getElementById('recommendation-topic').onclick = function(event) {
	            event.preventDefault();
	            var section = document.getElementById('recommendation-section');
	            if (section.style.display === 'none' || section.style.display === '') {
	                section.style.display = 'block';
	            } else {
	                section.style.display = 'none';
	            }
	        }
	     
	     	// 팝업 열기 버튼
	        document.getElementById('openPopupBtn').onclick = function(event) {
	            event.preventDefault();
	            document.getElementById('writing-popup').style.display = 'block';
	            fetchRandomTopic();
	        }

	        // 팝업 닫기 버튼
	        document.getElementById('close-writing-PopupBtn').onclick = function() {
	            document.getElementById('writing-popup').style.display = 'none';
	        }

	        // 일기 폼 제출
	        document.getElementById('diaryForm').onsubmit = function(event) {
	            event.preventDefault();
	            alert('일기가 저장되었습니다!');
	            document.getElementById('writing-popup').style.display = 'none';
	        }
	        
	        //주제 추천
	        //팝업 열기
	        document.getElementById('rcBtn').onclick = function(event) {
	            event.preventDefault();
	            document.getElementById('recommendation-popup').style.display = 'block';
	        }
	
	        // 추천 팝업 닫기 버튼
	        document.getElementById('closeRcPopupBtn').onclick = function() {
	            document.getElementById('recommendation-popup').style.display = 'none';
	        }
	        
	     	// 주제 추천 폼 제출
	        document.getElementById('rccompleteBtn').onclick = function(event) {
            event.preventDefault();
            var topicContent = document.getElementById('topicContent').value;
            
            fetch('/api/topic/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ topic: topicContent })
            })
            .then(response => response.json())
            .then(data => {
                alert('주제가 저장되었습니다!');
                document.getElementById('recommendation-popup').style.display = 'none';
                document.getElementById('topicContent').value = '';
            })
            .catch(error => console.error('Error:', error));
        }
	     	
	     	// 주제 가져오기
	        function fetchRandomTopic() {
	            fetch('/api/topic/random')
	            .then(response => response.json())
	            .then(data => {
	            	console.log(data);
	                document.getElementById('randomTopic').innerText = data.topic;
	            })
	            .catch(error => {
	            	console.error('Error:', error);
	                console.error('Error:', error);
	                document.getElementById('randomTopic').innerText = '주제를 불러오는데 실패했습니다.';
	            });
	        }
	     	
	     	<!-- 일기 저장 -->
	     	function validateForm() {
	            const diaryTitle = document.getElementById('diaryTitle').value;
	            const diaryContent = document.getElementById('diaryContent').value;
	            const visibility = document.querySelector('input[name="visibility"]:checked');
	            
	            if (diaryTitle.length < 1) {
	                alert('제목은 빈칸으로 둘 수 없습니다.');
	                return false;
	            }

	            if (diaryContent.length < 1) {
	                alert('내용은 비워둘 수 없습니다.');
	                return false;
	            }

	            if (!visibility) {
	                alert('공개 여부를 선택해야 합니다.');
	                return false;
	            }

	            return true;
	        }

	        async function checkUserSession() {
	        	const response = await fetch('/api/session/userinfo', {
	                method: 'GET',
	                credentials: 'include'
	            });
	            if (response.status === 200) {
	                const result = await response.json();
	                return result.userID !== undefined;
	            } else {
	                return false;
	            }
	        }

	        $(document).ready(function() {
	            $('#writing-btn').on('click', async function(event) {
	                event.preventDefault();

	                if (!validateForm()) {
	                    return;
	                }

	                const isLoggedIn = await checkUserSession();
	                if (!isLoggedIn) {
	                    alert('일기장을 쓰시려면 로그인 해야 합니다.');
	                    return;
	                }

	                if (confirm('저장하시겠습니까?')) {
	                    const formData = {
	                        diaryTitle: $('#diaryTitle').val(),
	                        diaryContent: $('#diaryContent').val(),
	                        visibility: $('input[name="visibility"]:checked').val()
	                    };

	                    $.ajax({
	                        type: 'POST',
	                        url: 'http://localhost:8080/api/my_diary',
	                        data: formData,
	                        contentType: 'application/x-www-form-urlencoded; charset=utf-8',
	                        success: function(response) {
	                            console.log('Success:', response);
	                            alert('다이어리 작성이 성공적으로 완료되었습니다.');
	                            window.location.href = 'my_diary.html';
	                        },
	                        error: function(error) {
	                            console.error('Error:', error);
	                            alert('다이어리 작성 중 오류가 발생했습니다.');
	                        }
	                    });
	                }
	            });
	        });
	        
	        function toggleLike(element) {
	            var likeContainer = $(element).closest('.like-container');
	            var liked = likeContainer.data('liked');
	            var likeCountSpan = likeContainer.find('.like-count');
	            var likeCount = parseInt(likeCountSpan.text());

	            if (liked) {
	                likeCount--;
	                element.innerHTML = '&#9825;'; 
	            } else {
	                likeCount++;
	                element.innerHTML = '&#9829;'; 
	                $(element).addClass('liked');
	            }

	            likeContainer.data('liked', !liked);
	            likeCountSpan.text(likeCount);
	        }
	        
	    </script>
    </body>
</html>